<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Exsaver RTU v3.7 - Self Testing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { width: 1024px; height: 600px; overflow: hidden; background-color: #020617; }
        .scroll-container { height: 460px; overflow-y: auto; scrollbar-width: thin; }
        .blueprint-container { position: relative; width: 900px; height: 450px; background-size: 100% 100%; margin: 0 auto; border: 1px solid #1e293b; background-color: #000; }
        .group-layer { position: absolute; cursor: pointer; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; transition: 0.3s; }
        .edit-mode .group-layer { border: 2px dashed #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .status-off { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); }
        .status-on { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.4); }
        .modal-bg { background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); position: fixed; inset: 0; z-index: 1000; }
    </style>
</head>
<body class="text-white font-sans text-sm">

    <div id="page-user" class="flex flex-col h-full">
        <header class="p-3 flex justify-between items-center bg-slate-900 border-b border-slate-800 shadow-xl">
            <h1 class="text-lg font-black text-blue-500 italic uppercase">RTU MONITORING v3.7</h1>
            <div class="flex items-center gap-5">
                <div id="top-clock" class="font-mono text-slate-400">00:00:00</div>
                <button onclick="showLogin()" class="px-4 py-1.5 bg-blue-600 rounded-lg font-bold text-xs">üîí ADMIN</button>
            </div>
        </header>
        <main class="flex-1 flex flex-col justify-center relative p-4">
            <div id="blueprint" class="blueprint-container shadow-2xl"></div>
            <button class="absolute left-4 p-5 bg-slate-800/40 rounded-full hover:bg-blue-600" onclick="changePage(-1)">‚Üê</button>
            <button class="absolute right-4 p-5 bg-slate-800/40 rounded-full hover:bg-blue-600" onclick="changePage(1)">‚Üí</button>
            
            <div id="edit-controls" class="hidden absolute bottom-6 flex gap-3 bg-slate-900/95 p-4 rounded-2xl border border-blue-900 shadow-2xl">
                <button onclick="addGroup()" class="px-6 py-2 bg-emerald-600 rounded-xl font-bold">+ Í∑∏Î£π Íµ¨Ïó≠ Ï∂îÍ∞Ä</button>
                <button onclick="saveEdit()" class="px-8 py-2 bg-blue-600 rounded-xl font-bold">Ìé∏Ïßë ÏôÑÎ£å</button>
            </div>
        </main>
    </div>

    <div id="page-admin-main" class="hidden flex flex-col h-full bg-slate-950">
        <nav class="p-3 bg-slate-900 border-b border-slate-800 flex justify-between items-center shadow-md">
            <div class="flex gap-2 bg-slate-800 p-1 rounded-xl">
                <button id="tab-individual" onclick="switchTab('individual')" class="px-5 py-2 bg-blue-600 rounded-lg font-bold text-xs">Í∞úÏù∏Î≥Ñ</button>
                <button id="tab-group" onclick="switchTab('group')" class="px-5 py-2 rounded-lg text-slate-400 text-xs">Í∑∏Î£πÎ≥Ñ</button>
                <button id="tab-floor" onclick="switchTab('floor')" class="px-5 py-2 rounded-lg text-slate-400 text-xs">Ï∏µÎ≥Ñ</button>
            </div>
            <div class="flex gap-3">
                <button onclick="enterEditMode()" class="px-5 py-2 bg-amber-600 rounded-lg font-bold text-xs">ÎèÑÎ©¥ Ìé∏Ïßë</button>
                <button onclick="location.reload()" class="px-5 py-2 bg-slate-800 rounded-lg text-xs">LOGOUT</button>
            </div>
        </nav>
        <div class="scroll-container p-4">
            <table class="w-full text-center border-separate border-spacing-y-2">
                <thead id="admin-table-head" class="sticky top-0 bg-slate-950 z-10 text-[10px] text-slate-500 uppercase"></thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="page-login" class="hidden fixed inset-0 z-[500] modal-bg flex items-center justify-center">
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 w-[320px] text-center shadow-2xl">
            <h2 class="text-xs font-bold mb-6 text-slate-500 tracking-widest uppercase">Admin Verification</h2>
            <div id="pin-display" class="bg-black p-4 mb-6 rounded-2xl text-4xl h-16 flex items-center justify-center font-mono tracking-[0.3em]"></div>
            <div class="grid grid-cols-3 gap-2">
                <script>for(let i=1; i<=9; i++) document.write(`<button onclick="pressKey('${i}')" class="py-4 bg-slate-800 rounded-xl text-xl active:bg-blue-600">${i}</button>`);</script>
                <button onclick="clearPin()" class="py-4 bg-red-900/30 text-red-500 rounded-xl font-bold">C</button>
                <button onclick="pressKey('0')" class="py-4 bg-slate-800 rounded-xl text-xl">0</button>
                <button onclick="hideLogin()" class="py-4 bg-slate-700 rounded-xl text-xs uppercase">Back</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î∞è ÏÉÅÌÉú ---
        const initialData = {
            1: [ {t:15, l:15, w:250, h:150, id:1, name: "1Ï∏µ ÏÇ¨Î¨¥Íµ¨Ïó≠", lcuIds: [1,2,3], status:'OFF'} ],
            2: [ {t:30, l:30, w:300, h:200, id:2, name: "2Ï∏µ Ïã§ÌóòÏã§", lcuIds: [6,7], status:'OFF'} ],
            3: [ {t:50, l:40, w:200, h:120, id:3, name: "3Ï∏µ ÎåÄÌöåÏùòÏã§", lcuIds: [11], status:'OFF'} ]
        };

        let layoutData = JSON.parse(localStorage.getItem('rtu_final_data')) || initialData;
        let curPage = 1, pin = "", isEditMode = false, currentTab = 'individual';

        // --- 2. ÏûêÎèô ÌÖåÏä§Ìä∏ ÏóîÏßÑ (Diagnostic Tool) ---
        function runAutoTest() {
            console.group("%cüõ† RTU System ÏûêÎèô Í≤ÄÏ¶ù Î¶¨Ìè¨Ìä∏", "color: #3b82f6; font-size: 14px; font-weight: bold;");
            const tests = [];

            // Test 1: PIN Î≥¥Ïïà Î°úÏßÅ Í≤ÄÏ¶ù
            const testPin = (p) => { pin = p; return (pin === "0000"); };
            tests.push({ name: "PIN Ïù∏Ï¶ù (ÎßûÎäî Î≤àÌò∏)", result: testPin("0000") === true });
            tests.push({ name: "PIN Ïù∏Ï¶ù (ÌãÄÎ¶∞ Î≤àÌò∏)", result: testPin("1111") === false });

            // Test 2: Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± Í≤ÄÏ¶ù
            tests.push({ name: "Ï∏µÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌôïÏù∏", result: !!layoutData[1] && !!layoutData[2] && !!layoutData[3] });

            // Test 3: ÏÉÅÌÉú Î≥ÄÍ≤Ω Î∞è ÏòÅÍµ¨ Ï†ÄÏû• Î°úÏßÅ Í≤ÄÏ¶ù
            const originalStatus = layoutData[1][0].status;
            layoutData[1][0].status = 'ON';
            saveData();
            const savedData = JSON.parse(localStorage.getItem('rtu_final_data'));
            tests.push({ name: "ÏÉÅÌÉú Î≥ÄÍ≤Ω Î∞è LocalStorage Ï†ÄÏû•", result: savedData[1][0].status === 'ON' });
            layoutData[1][0].status = originalStatus; // ÏõêÏÉÅÎ≥µÍµ¨
            saveData();

            // Test 4: UI ÏöîÏÜå Ï°¥Ïû¨ ÌôïÏù∏
            tests.push({ name: "Ï£ºÏöî DOM ÏöîÏÜå Ï°¥Ïû¨ ÌôïÏù∏", result: !!document.getElementById('blueprint') && !!document.getElementById('page-admin-main') });

            // Í≤∞Í≥º Ï∂úÎ†•
            tests.forEach((t, i) => {
                const icon = t.result ? "‚úÖ" : "‚ùå";
                const color = t.result ? "color: #10b981" : "color: #ef4444";
                console.log(`${i+1}. ${t.name}: %c${icon}`, color);
            });
            console.groupEnd();
        }

        // --- 3. ÌïµÏã¨ Í∏∞Îä• Ìï®ÏàòÎì§ ---
        function updatePage() {
            const container = document.getElementById('blueprint');
            container.style.backgroundImage = `url('rtu_ui${curPage === 1 ? '' : curPage}.jpg')`;
            renderLayers();
        }

        function renderLayers() {
            const container = document.getElementById('blueprint');
            container.innerHTML = '';
            (layoutData[curPage] || []).forEach((group, idx) => {
                const layer = document.createElement('div');
                layer.className = `group-layer ${isEditMode ? 'edit-mode' : (group.status==='ON'?'status-on':'status-off')}`;
                layer.style.cssText = `top:${group.t}%; left:${group.l}%; width:${group.w}px; height:${group.h}px;`;
                layer.innerHTML = `<div class="bg-black/70 px-3 py-1 rounded text-xs font-bold border border-white/10">${group.name}</div>`;
                
                layer.onclick = () => { if(!isEditMode && group.status === 'OFF') handleControl(curPage, idx, 'ON'); };
                container.appendChild(layer);
            });
        }

        function handleControl(pg, idx, target) {
            if(confirm(`[${layoutData[pg][idx].name}] Íµ¨Ïó≠ÏùÑ ${target} ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                layoutData[pg][idx].status = target;
                saveData(); renderLayers(); if(currentTab) renderAdminTable();
            }
        }

        function switchTab(t) {
            currentTab = t;
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('bg-blue-600', 'text-slate-400'));
            document.getElementById('tab-'+t).className = "px-5 py-2 bg-blue-600 rounded-lg font-bold text-xs transition";
            renderAdminTable();
        }

        function renderAdminTable() {
            const body = document.getElementById('admin-table-body');
            body.innerHTML = '';
            // Í∞ÑÎã®Ìïú Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ (ÌÖåÏä§Ìä∏Ïö©)
            Object.keys(layoutData).forEach(pg => {
                layoutData[pg].forEach((g, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = "bg-slate-900 border border-slate-800 hover:bg-slate-800 transition";
                    tr.innerHTML = `<td class="p-4 font-bold text-blue-400">${g.name}</td><td>${(Math.random()*2).toFixed(1)}</td><td>${(Math.random()*50).toFixed(1)}</td><td><button onclick="handleControl(${pg},${idx},'${g.status==='ON'?'OFF':'ON'}')" class="px-4 py-1 rounded-full ${g.status==='ON'?'bg-green-600':'bg-red-600'}">${g.status}</button></td>`;
                    body.appendChild(tr);
                });
            });
        }

        function saveData() { localStorage.setItem('rtu_final_data', JSON.stringify(layoutData)); }
        function showLogin() { pin = ""; document.getElementById('pin-display').innerText = ""; document.getElementById('page-login').classList.remove('hidden'); }
        function hideLogin() { document.getElementById('page-login').classList.add('hidden'); }
        function pressKey(n) { if(pin.length<4) { pin+=n; document.getElementById('pin-display').innerText='‚óè'.repeat(pin.length); } if(pin.length===4) { if(pin==="0000") { document.getElementById('page-login').classList.add('hidden'); document.getElementById('page-user').classList.add('hidden'); document.getElementById('page-admin-main').classList.remove('hidden'); switchTab('individual'); } else { alert("PIN Ïò§Î•ò"); pin=""; document.getElementById('pin-display').innerText=""; } } }
        function changePage(d) { curPage = Math.max(1, Math.min(3, curPage + d)); updatePage(); }
        function enterEditMode() { isEditMode = true; document.getElementById('page-admin-main').classList.add('hidden'); document.getElementById('page-user').classList.remove('hidden'); document.getElementById('edit-controls').classList.remove('hidden'); renderLayers(); }
        function saveEdit() { isEditMode = false; document.getElementById('edit-controls').classList.add('hidden'); document.getElementById('page-user').classList.add('hidden'); document.getElementById('page-admin-main').classList.remove('hidden'); saveData(); renderAdminTable(); }

        setInterval(() => { document.getElementById('top-clock').innerText = new Date().toLocaleTimeString(); }, 1000);

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÎèô Ïã§Ìñâ
        window.onload = () => {
            updatePage();
            runAutoTest(); // ÏûêÎèô ÌÖåÏä§Ìä∏ Ìï®Ïàò Ìò∏Ï∂ú
        };
    </script>
</body>
</html>
