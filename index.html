<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Exsaver RTU v3.1 (7-inch Optimized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 7ì¸ì¹˜ ë””ìŠ¤í”Œë ˆì´(ì•½ 1024x600) ìµœì í™” */
        body { width: 1024px; height: 600px; overflow: hidden; background-color: #020617; }
        .scroll-container { height: 480px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #334155 #0f172a; }
        .blueprint-container { position: relative; width: 900px; height: 450px; background-size: 100% 100%; margin: 0 auto; border: 1px solid #1e293b; }
        .lcu-layer { position: absolute; display: flex; align-items: center; justify-content: center; min-width: 40px; min-height: 40px; cursor: pointer; }
        .edit-mode .lcu-layer { border: 1px dashed #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .lcu-status-dot { width: 28px; height: 28px; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: 0.3s; }
        .status-on { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-off { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .modal-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-white font-sans text-sm">

    <div id="page-user" class="flex flex-col h-full">
        <header class="p-3 flex justify-between items-center bg-slate-900 border-b border-slate-800">
            <h1 class="text-lg font-bold text-blue-500 italic">RTU MONITOR</h1>
            <div class="flex items-center gap-4">
                <div id="top-clock" class="font-mono text-slate-400">00:00:00</div>
                <button onclick="showLogin()" class="px-3 py-1 bg-slate-800 rounded border border-slate-700 text-xs">ğŸ”’ ê´€ë¦¬ì</button>
            </div>
        </header>
        <main class="flex-1 flex flex-col justify-center relative">
            <div id="blueprint" class="blueprint-container"></div>
            <button class="absolute left-2 p-4 bg-slate-800/50 rounded-full" onclick="changePage(-1)">â†</button>
            <button class="absolute right-2 p-4 bg-slate-800/50 rounded-full" onclick="changePage(1)">â†’</button>
        </main>
    </div>

    <div id="page-admin-main" class="hidden flex flex-col h-full bg-slate-950">
        <nav class="p-3 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
            <div class="flex gap-2">
                <button id="tab-individual" onclick="switchAdminTab('individual')" class="px-4 py-1.5 bg-blue-600 rounded font-bold text-xs">ê°œì¸ë³„</button>
                <button id="tab-group" onclick="switchAdminTab('group')" class="px-4 py-1.5 bg-slate-800 rounded text-xs">ê·¸ë£¹ë³„</button>
            </div>
            <div class="flex gap-2">
                <button onclick="enterGroupEdit()" class="px-3 py-1.5 bg-amber-600 rounded font-bold text-xs">ë„ë©´ í¸ì§‘</button>
                <button onclick="location.reload()" class="px-3 py-1.5 bg-slate-800 rounded text-xs">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
        
        <div class="scroll-container p-4">
            <table class="w-full text-center border-separate border-spacing-y-2">
                <thead id="admin-table-head" class="sticky top-0 bg-slate-950 z-10"></thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-detail" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
        <div class="bg-slate-900 w-[900px] h-[500px] rounded-xl border border-slate-700 p-6 relative shadow-2xl">
            <button onclick="closeDetail()" class="absolute top-4 right-6 text-2xl text-slate-500 hover:text-white">âœ•</button>
            <h3 id="detail-title" class="text-xl font-bold mb-4 text-blue-400">ë°ì´í„° ë¶„ì„</h3>
            <div class="h-[380px] w-full"><canvas id="detailChart"></canvas></div>
        </div>
    </div>

    <div id="page-login" class="hidden fixed inset-0 z-[200] modal-overlay flex items-center justify-center">
        <div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-[300px] text-center">
            <h2 class="text-sm font-bold mb-4 text-slate-400">ê´€ë¦¬ì ì¸ì¦</h2>
            <div id="pin-display" class="bg-black p-3 mb-4 rounded-xl text-2xl h-12 flex items-center justify-center tracking-widest"></div>
            <div class="grid grid-cols-3 gap-2">
                <script>for(let i=1; i<=9; i++) document.write(`<button onclick="pressKey('${i}')" class="w-full py-3 bg-slate-800 rounded-lg text-xl active:bg-blue-600">${i}</button>`);</script>
                <button onclick="clearPin()" class="py-3 bg-red-900/50 text-red-500 rounded-lg">C</button>
                <button onclick="pressKey('0')" class="py-3 bg-slate-800 rounded-lg text-xl">0</button>
                <button onclick="hideLogin()" class="py-3 bg-slate-700 rounded-lg text-xs">Back</button>
            </div>
        </div>
    </div>

    <script>
        // ì´ˆê¸° ë°ì´í„° (ì´ë¦„ ë³€ê²½: 1ì¸µ ì‚¬ë¬´ì‹¤)
        const initialPageData = {
            1: { name: "1ì¸µ ì‚¬ë¬´ì‹¤", lcus: [ {t:20, l:15, w:80, h:60, id:1, status:'OFF'}, {t:20, l:35, w:80, h:60, id:2, status:'OFF'}, {t:20, l:55, w:80, h:60, id:3, status:'OFF'} ] },
            2: { name: "2ì¸µ ì—°êµ¬ì‹¤", lcus: [ {t:40, l:20, w:80, h:60, id:6, status:'OFF'}, {t:40, l:45, w:80, h:60, id:7, status:'OFF'} ] },
            3: { name: "3ì¸µ íšŒì˜ì‹¤", lcus: [ {t:60, l:40, w:80, h:60, id:11, status:'OFF'} ] }
        };

        let pageData = JSON.parse(localStorage.getItem('rtu_v31_data')) || initialPageData;
        let curPage = 1, pin = "", isEditMode = false, currentTab = 'individual', myChart = null;

        function updatePage() {
            const container = document.getElementById('blueprint');
            container.style.backgroundImage = `url('rtu_ui${curPage === 1 ? '' : curPage}.jpg')`;
            renderLayers();
        }

        function renderLayers() {
            const container = document.getElementById('blueprint');
            container.innerHTML = '';
            const current = pageData[curPage] || { name: `ë„ë©´ ${curPage}`, lcus: [] };
            
            current.lcus.forEach((lcu, idx) => {
                const rect = document.createElement('div');
                rect.className = `lcu-layer ${isEditMode ? 'edit-mode' : ''}`;
                rect.style.cssText = `top:${lcu.t}%; left:${lcu.l}%; width:${lcu.w}px; height:${lcu.h}px;`;

                const dot = document.createElement('div');
                dot.className = `lcu-status-dot ${lcu.status === 'ON' ? 'status-on' : 'status-off'}`;
                dot.innerText = lcu.id.toString().padStart(2, '0');
                rect.appendChild(dot);

                rect.onclick = () => { if(!isEditMode && lcu.status === 'OFF') toggleLcu(curPage, idx); };
                container.appendChild(rect);
            });
        }

        // ì œì–´ ë¡œì§ (ê°œë³„/ê·¸ë£¹)
        function toggleLcu(pg, idx) {
            const lcu = pageData[pg].lcus[idx];
            lcu.status = lcu.status === 'ON' ? 'OFF' : 'ON';
            save(); renderLayers(); if(!isEditMode) renderAdminTable();
        }

        function groupControl(pg, targetStatus) {
            if(!confirm(`ê·¸ë£¹ ë‚´ ëª¨ë“  LCUë¥¼ ${targetStatus} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            pageData[pg].lcus.forEach(l => l.status = targetStatus);
            save(); renderLayers(); renderAdminTable();
        }

        // ê´€ë¦¬ì í…Œì´ë¸” (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
        function renderAdminTable() {
            const head = document.getElementById('admin-table-head');
            const body = document.getElementById('admin-table-body');
            body.innerHTML = '';

            if(currentTab === 'individual') {
                head.innerHTML = '<tr class="text-slate-500 text-[10px] uppercase"><th>ëª…ì¹­</th><th>ì ˆê°ëŸ‰</th><th>ëˆ„ì ëŸ‰</th><th>í˜„ì¬ìƒíƒœ</th></tr>';
                Object.keys(pageData).forEach(pg => {
                    pageData[pg].lcus.forEach((lcu, idx) => {
                        const tr = document.createElement('tr');
                        tr.className = "bg-slate-900 border border-slate-800 hover:bg-slate-800 transition cursor-pointer";
                        tr.innerHTML = `
                            <td class="p-3 text-blue-400 font-bold" onclick="showGraph('LCU ${lcu.id}')">${pageData[pg].name}-0${lcu.id}</td>
                            <td class="text-xs font-mono">${(Math.random()*2).toFixed(1)}kW</td>
                            <td class="text-xs font-mono">${(Math.random()*50).toFixed(1)}kWh</td>
                            <td><button onclick="toggleLcu(${pg}, ${idx})" class="px-3 py-1 rounded-full text-[10px] font-bold ${lcu.status === 'ON' ? 'bg-green-600' : 'bg-red-600'}">${lcu.status}</button></td>
                        `;
                        body.appendChild(tr);
                    });
                });
            } else {
                head.innerHTML = '<tr class="text-slate-500 text-[10px] uppercase"><th>ê·¸ë£¹ëª…(êµ¬ì—­)</th><th>í‰ê· ì ˆê°</th><th>ì¼ê´„ ì œì–´</th></tr>';
                Object.keys(pageData).forEach(pg => {
                    const group = pageData[pg];
                    const tr = document.createElement('tr');
                    tr.className = "bg-slate-900 border border-slate-800 p-2";
                    tr.innerHTML = `
                        <td class="p-4 text-left pl-6 font-bold text-amber-400" onclick="showGraph('${group.name}')">${group.name}</td>
                        <td class="text-xs font-mono">${(Math.random()*5).toFixed(1)}kW</td>
                        <td class="flex justify-center gap-2 p-3">
                            <button onclick="groupControl(${pg}, 'ON')" class="px-4 py-1.5 bg-green-700 rounded text-[10px] font-bold">ALL ON</button>
                            <button onclick="groupControl(${pg}, 'OFF')" class="px-4 py-1.5 bg-red-700 rounded text-[10px] font-bold">ALL OFF</button>
                        </td>
                    `;
                    body.appendChild(tr);
                });
                // [ê·¸ë£¹ ì¶”ê°€ ë²„íŠ¼] í…Œì´ë¸” í•˜ë‹¨ì— ë°°ì¹˜
                const addTr = document.createElement('tr');
                addTr.innerHTML = `<td colspan="3" class="p-4"><button onclick="addGroup()" class="w-full py-2 border border-dashed border-slate-700 text-slate-500 rounded">+ ìƒˆ ê·¸ë£¹ ì¶”ê°€</button></td>`;
                body.appendChild(addTr);
            }
        }

        function addGroup() {
            const name = prompt("ìƒˆ ê·¸ë£¹ ëª…ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”:", "Group " + (Object.keys(pageData).length + 1));
            if(name) {
                const newPg = Object.keys(pageData).length + 1;
                pageData[newPg] = { name: name, lcus: [] };
                save(); renderAdminTable();
            }
        }

        // ê·¸ë˜í”„ (ë§¨ ì˜¤ë¥¸ìª½ì´ í˜„ì¬ ì‹œê°„)
        function showGraph(title) {
            document.getElementById('modal-detail').classList.remove('hidden');
            document.getElementById('detail-title').innerText = title + " ë¶„ì„";
            const ctx = document.getElementById('detailChart').getContext('2d');
            if(myChart) myChart.destroy();
            const now = new Date().getHours();
            const labels = Array.from({length: 24}, (_, i) => ((now-23+i+24)%24) + "ì‹œ");
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ìˆœì‹œì „ë ¥', data: labels.map(()=>Math.random()*1.5), borderColor: '#10b981', tension: 0.4 },
                        { label: 'ì ˆê°ëŸ‰', data: labels.map(()=>Math.random()*10), borderColor: '#3b82f6', backgroundColor:'rgba(59,130,246,0.1)', fill:true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, color: '#94a3b8' }
            });
        }

        // ê³µí†µ ìœ í‹¸ë¦¬í‹°
        function save() { localStorage.setItem('rtu_v31_data', JSON.stringify(pageData)); }
        function showLogin() { pin = ""; document.getElementById('pin-display').innerText = ""; document.getElementById('page-login').classList.remove('hidden'); }
        function hideLogin() { document.getElementById('page-login').classList.add('hidden'); }
        function pressKey(n) { if(pin.length<4) { pin+=n; document.getElementById('pin-display').innerText='â—'.repeat(pin.length); } if(pin.length===4) { if(pin==="0000") { document.getElementById('page-login').classList.add('hidden'); document.getElementById('page-user').classList.add('hidden'); document.getElementById('page-admin-main').classList.remove('hidden'); switchAdminTab('individual'); } else { alert("PIN ì˜¤ë¥˜"); pin=""; document.getElementById('pin-display').innerText=""; } } }
        function clearPin() { pin = ""; document.getElementById('pin-display').innerText = ""; }
        function switchAdminTab(t) { currentTab = t; renderAdminTable(); }
        function changePage(d) { curPage = Math.max(1, Math.min(3, curPage + d)); updatePage(); }
        function closeDetail() { document.getElementById('modal-detail').classList.add('hidden'); }
        setInterval(() => { document.getElementById('top-clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        window.onload = updatePage;
    </script>
</body>
</html>
