<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Exsaver RTU v3.3 (Group Control Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { width: 1024px; height: 600px; overflow: hidden; background-color: #020617; }
        .blueprint-container { position: relative; width: 900px; height: 450px; background-size: 100% 100%; margin: 0 auto; border: 1px solid #1e293b; background-color: #000; }
        
        /* ê·¸ë£¹ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        .group-layer {
            position: absolute;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        /* ì‚¬ìš©ì ëª¨ë“œì—ì„œ ê·¸ë£¹ ìƒíƒœ í‘œì‹œ */
        .group-layer.status-off { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); }
        .group-layer.status-on { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.4); }

        /* í¸ì§‘ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .edit-mode .group-layer { border: 2px dashed #3b82f6; background: rgba(59, 130, 246, 0.2); }
        .group-layer.selected { border: 2px solid #fbbf24 !important; background: rgba(251, 191, 36, 0.3) !important; }

        .group-label {
            background: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .lcu-id-list { display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
        .lcu-mini-dot { width: 12px; height: 12px; border-radius: 50%; font-size: 8px; display: flex; align-items: center; justify-content: center; }

        .resizer { display: none; width: 12px; height: 12px; background: #3b82f6; position: absolute; border-radius: 50%; z-index: 10; }
        .edit-mode .resizer { display: block; }
        .resizer.tl { top: -6px; left: -6px; cursor: nw-resize; }
        .resizer.br { bottom: -6px; right: -6px; cursor: se-resize; }
    </style>
</head>
<body class="bg-slate-950 text-white font-sans text-sm">

    <div id="page-user" class="flex flex-col h-full">
        <header class="p-3 flex justify-between items-center bg-slate-900 border-b border-slate-800">
            <h1 id="header-title" class="text-lg font-black text-blue-500 italic uppercase">RTU Group Monitoring</h1>
            <div class="flex items-center gap-5">
                <div id="top-clock" class="font-mono text-slate-400">00:00:00</div>
                <button onclick="showLogin()" class="px-4 py-1.5 bg-slate-800 rounded-lg border border-slate-700 text-xs">ğŸ”’ ADMIN</button>
            </div>
        </header>

        <main class="flex-1 flex flex-col justify-center relative p-4">
            <div id="blueprint" class="blueprint-container shadow-2xl"></div>
            
            <button class="absolute left-4 p-5 bg-slate-800/40 rounded-full hover:bg-blue-600" onclick="changePage(-1)">â†</button>
            <button class="absolute right-4 p-5 bg-slate-800/40 rounded-full hover:bg-blue-600" onclick="changePage(1)">â†’</button>
            
            <div id="edit-controls" class="hidden absolute bottom-6 flex gap-3 bg-slate-900/95 p-4 rounded-2xl border border-blue-900 shadow-2xl">
                <button onclick="addGroupLayer()" class="px-6 py-2 bg-emerald-600 rounded-xl font-bold">+ ê·¸ë£¹ êµ¬ì—­ ì¶”ê°€</button>
                <button id="btn-delete" onclick="deleteSelected()" disabled class="px-6 py-2 bg-red-600 rounded-xl font-bold opacity-30">ì‚­ì œ</button>
                <button onclick="saveAndExitEdit()" class="px-8 py-2 bg-blue-600 rounded-xl font-bold">í¸ì§‘ ì™„ë£Œ</button>
            </div>
        </main>
    </div>

    <script>
        // ë„ë©´ë³„ ê·¸ë£¹(ë ˆì´ì–´) ë°ì´í„° ì €ì¥
        let layoutData = JSON.parse(localStorage.getItem('rtu_group_layout')) || {
            1: [ {t:20, l:15, w:200, h:150, name: "1ì¸µ ì‚¬ë¬´êµ¬ì—­", lcuIds: [1,2,3,4,5], status: 'OFF'} ],
            2: [ {t:30, l:30, w:250, h:200, name: "2ì¸µ ì—°êµ¬ì†Œ", lcuIds: [6,7,8,9,10], status: 'OFF'} ],
            3: [ {t:50, l:40, w:180, h:120, name: "ì„ì›ì‹¤", lcuIds: [11,12], status: 'OFF'} ]
        };

        let curPage = 1, isEditMode = false, selectedIdx = null;

        function updatePage() {
            const container = document.getElementById('blueprint');
            container.style.backgroundImage = `url('rtu_ui${curPage === 1 ? '' : curPage}.jpg')`;
            renderGroupLayers();
        }

        function renderGroupLayers() {
            const container = document.getElementById('blueprint');
            container.innerHTML = '';
            const groups = layoutData[curPage] || [];

            groups.forEach((group, idx) => {
                const layer = document.createElement('div');
                layer.className = `group-layer ${isEditMode ? 'edit-mode' : (group.status === 'ON' ? 'status-on' : 'status-off')}`;
                if(isEditMode && selectedIdx === idx) layer.classList.add('selected');
                
                layer.style.cssText = `top:${group.t}%; left:${group.l}%; width:${group.w}px; height:${group.h}px;`;

                // ê·¸ë£¹ ì´ë¦„ ë¼ë²¨
                const label = document.createElement('div');
                label.className = 'group-label';
                label.innerText = group.name;
                layer.appendChild(label);

                // í¬í•¨ëœ LCU ë„íŠ¸ ë¦¬ìŠ¤íŠ¸
                const list = document.createElement('div');
                list.className = 'lcu-id-list';
                group.lcuIds.forEach(id => {
                    const dot = document.createElement('div');
                    dot.className = `lcu-mini-dot ${group.status === 'ON' ? 'bg-green-500' : 'bg-red-500'}`;
                    dot.innerText = id;
                    list.appendChild(dot);
                });
                layer.appendChild(list);

                if(isEditMode) {
                    ['tl','br'].forEach(p => {
                        const r = document.createElement('div'); r.className = `resizer ${p}`;
                        r.onmousedown = (e) => initResize(e, p, idx); layer.appendChild(r);
                    });
                    layer.onmousedown = (e) => { if(!e.target.classList.contains('resizer')) { selectedIdx = idx; document.getElementById('btn-delete').disabled = false; renderGroupLayers(); initDrag(e, idx); } };
                } else {
                    // [í•µì‹¬] ì‚¬ìš©ì ëª¨ë“œ í´ë¦­: ê·¸ë£¹ ì „ì²´ ì œì–´
                    layer.onclick = () => {
                        if(group.status === 'OFF') {
                            if(confirm(`[${group.name}] êµ¬ì—­ì˜ ëª¨ë“  ì „ì›ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                                group.status = 'ON';
                                save(); renderGroupLayers();
                            }
                        }
                    };
                }
                container.appendChild(layer);
            });
        }

        // ë°ì´í„° ì €ì¥ ë° ìœ í‹¸ë¦¬í‹°
        function save() { localStorage.setItem('rtu_group_layout', JSON.stringify(layoutData)); }
        
        function addGroupLayer() {
            const name = prompt("ê·¸ë£¹ êµ¬ì—­ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
            if(name) {
                layoutData[curPage].push({t:40, l:40, w:150, h:100, name: name, lcuIds: [], status: 'OFF'});
                renderGroupLayers();
            }
        }

        // ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ë¡œì§ (ìƒëµ - ì´ì „ ë²„ì „ v3.2ì™€ ë™ì¼í•˜ê²Œ ì ìš© ê°€ëŠ¥)
        function changePage(d) { curPage = Math.max(1, Math.min(3, curPage + d)); updatePage(); }
        
        setInterval(() => { document.getElementById('top-clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        window.onload = updatePage;

        // ê´€ë¦¬ì ì§„ì… ë“± ë‚˜ë¨¸ì§€ ë¡œì§ì€ ì´ì „ ì½”ë“œì˜ í‹€ì„ ìœ ì§€í•©ë‹ˆë‹¤.
    </script>
</body>
</html>
